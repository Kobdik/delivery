# InMemory OLAP-cube

Для анализа многомерных данных стандартные OLAP-инструменты при расчете сводных таблиц опираются на SQL-запросы GROUP BY CUBE по колонкам измерений, со сложностью вычислений O(2^k * n_rows), где k - количество колонок, n_rows - количество строк исходных многомерных данных. Для отчетов по глубоким иерархическим измерениям, k может означать 8-10 и более вложенных уровней (в сумме по обоим измерениям сводного отчета), что существенно увеличивывает время расчета.

Подробнее о сложности вычислений и скорости расчета: [Speed](https://kobdik.github.io/Cube/speed.html)

Я разработал прототип собственного OLAP-инструмента, который хорошо справляется с глубокими иерархиями и несбалансированными деревьями в качестве измерений, имея сложность порядка O(n_rows). Углубление иерархии на один уровень не ведет к двукратному замедлению расчета. Подробнее: [OLAP-cube](https://kobdik.github.io/Cube/)

# Анализ движения материалов

Одним из полезных применений OLAP-инструментов является отчет о движении материалов, аналог отчета о движении денежных средств, который позволяет выявлять дефицит материалов на складах, кассовые разрывы в теминах бюджета движения денежных средств.

Анализ движения материалов в качестве входных данных принимает начальные остатки по каждому складу в разрезе материалов, план поставок материалов от различных поставщиков, план потребления материальных ресурсов по проектам с детализацией по задачам. Суть анализа сводится к вычислению агрегированных показателей поступлений и расходования материалов, остатков на начало и конец каждого отчетного дня.

Пример реализации на базе моего OLAP-решения: 
[Анализ движения материалов](https://kobdik.github.io/Cube/flow.html)

Сложности возникают с генерацией данных для сценарного анализа. Если запасы были на низком уровне, а поставщик задержал поступление материалов хотя бы на один день, отодвигается выполнение десятков задач. Для аналитического отчета следует подготовить данные сценария со сторнирующими проводками для каждого отложенного задания, т.е. вычесть запланированные данные, добавить эти же данные со сдвигом на день.

Сдвиг поставки на день или более приводит ко множеству различных сценариев, потребление ресурсов может растянуться на большее число дней, так как имеются пределы дневного потребления ресурсов. Без имитационного моделирования возможных сценариев развития тут не обойтись.

# Имитационное моделирование управления материальными ресурсами 

Мною проведена экспериментальная разработка, включающая создание прототипов сервисов поставщиков, складов и конечных потребителей, а также синхронизирующего сервиса. Реализовано на стеке Golang + Kafka.

Сервис kronos отправляет начальное событие для подготовки других сервисов к началу 60-дневного цикла, затем, с заданным интервалом в сотню-другую миллисекунд генерирует в топик calend события наступления нового дня. 

Поставщики (сервис supplier) загружают планы поставок, для них в качестве параметра вводится вероятность исполнения заказа в срок. При получении события наступившего дня, поставщик с заданной вероятностью осуществляет запланированные на этот день поставки, отправляя в топик stocks события supply. 

Потребители (сервис outlet) загружают свои планы потребления и по мере наступления нового дня отправляют складам заявки-требования на запланированные в этот день отгрузки материалов, либо оставшиеся неотработанными заявки за предыдущие дни. Для этого в топик stocks отправляются события demand.

Склады (сервис storage) по мере наступления нового дня обновляют счетчики полученных требований, при получении событий от поставщиков увеличивают остатки материалов, по мере отработки заявок-требований от потребителей уменьшают остатки.

Отработка заявок-требований в общих чертах спроектирована следующим образом. Если остатков запрашиваемого материала достаточно, то потребителю по его заявкам отгружаются материалы и остатки материалов уменьшаются на величину отгрузок. Оповещение потребителя об отгрузке реализуется отправкой в топик outlet события outlay, которое позволяет потребителю удалить отработанную заявку. Если счетчик заявок перевалил за установленную на день норму, либо запрашиваемого материала на складе недостаточно, то заявка игнорируется.

Архитектура решения приведена на схеме: ![Архитектура решения](./images/delivery.png)

Сервис storage автоматически формирует отличный от запланированного поток многомерных данных для вероятных сценариев развития. Среди различных вариантов следует отобрать наиболее значимые сценарии, чтобы загрузить в аналитический инструмент и продемонстрировать руководству и другим заинтересованным лицам. Возникает потребность в формировании целевой функции для выявления наиболее значимых сценариев.

# Фактор времени при оценке денежных потоков

Рассмотрим управление запасами производственного или строительного предприятия. Поставщики матералов с некоторой регулярностью пополняют запасы, которые расходуются на реализуемые проекты. 

Реальная проблема заключается в изменчивости, связанной с неточными прогнозами и сбоями в цепочке поставок, включая задержки в поступлениях и выполнении заказов. Полностью устранить факторы неопределенности невозможно, однако, нужен инструмент для сокращения резервных запасов и уменьшения случаев дефицита (разрывов в материальных ресурсах). 

Вопрос в том, каков должен быть объем и сроки пополнения стратегических запасов. Дополнительный запас предотвращает дефицит, но хранение дополнительных запасов связывает денежные средства. 

Имеющиеся свободные деньги можно было бы инвестировать и получить дополнительный доход.
Ниже показаны три варианта динамики стоимости материальных запасов (стоимости остатков на начало дня и поступивших в течение этого дня материалов в условных единицах), которые эквивалентны с точки зрения связывания денег, при условии поставок в день оплаты и неизменности процентных ставок и цен на материальные ресурсы.

![Материальные запасы по дням](./images/запасы.png)

Все три варианта имеют одинаковую интегральную сумму, т.е. упущенный доход от инвестиций под процентную ставку на стоимость хранящихся материальных ресурсов, будет одинаков. Для сравнения различных вариантов динамики материальных запасов в качестве целевой функции хорошо подойдет интегральная сумма по материальным запасам и ежедневным затратам на содержание производства.
